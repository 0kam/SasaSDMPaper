# Materials and Methods

```{r}
#| echo: false
#| message: false
#| warning: false
library(magick)
```

Although demonstrated in a Japanese alpine system, the workflow presented here is applicable to any snow-dominated ecosystem monitored by fixed ground-based cameras, including existing alpine webcam networks such as those established in the Swiss Alps (@Portenier2020Cryosphere). The approach is designed as a biogeographic inference pipeline that links climate-driven processes, represented by snowmelt timing, to vegetation patterns and their redistribution under environmental change.

@fig-overview presents an overview of the workflow. Using time-lapse imagery from the northern Japanese Alps, we quantified *Sasa* expansion and measured the snowmelt day of year (DOY). *Sasa* expansion was assessed by comparing vegetation classification maps derived from imagery captured in 2012 and 2021, while snowmelt DOY was determined from imagery spanning 2011–2021. Based on the resulting *Sasa* distribution and its changes, together with snowmelt DOY and topographic features derived from a digital elevation model (DEM), we constructed habitat suitability models (HSMs) to predict *Sasa* distribution and expansion. Finally, we incorporated future snowmelt DOY projected from our observations into the HSMs to generate detailed forecasts of future *Sasa* invasion.

```{r}
#| label: fig-overview
#| echo: false
#| message: false
#| fig-cap: |
#|   Overview of the proposed method.  
#|   We used time-lapse imagery and a DEM for constructing HSMs for predicting the *Sasa* distribution. 
#| out-width: 100%
#| fig-align: center
image_read("files/overview.png")
```

## Image acquisition {#sec-image-acquisition}

To monitor the distribution of *Sasa*, we used images captured by a digital time-lapse camera (EOS 5D MK2, Canon Inc., 21 megapixels) installed by the National Institute for Environmental Studies on the Murodo-sanso mountain lodge (approximately 2,450 m a.s.l.) in the northern Japanese Alps. Since 2010, the camera has documented snowmelt and vegetation dynamics on the western slope of Mt. Tateyama (2,350–3,015 m), taking photographs hourly from 6:00 to 19:00 between April and November. For details of the installation and operation, see @Okamoto2024RSEC. In this study, we used images taken in September–October of 2012 and 2021 for quantifying *Sasa* expansion.

A major advantage of time-lapse cameras is their ability to capture fine-scale, daily changes in snow cover. Frequent cloud cover and the steep topography of alpine regions often hinder continuous satellite observations, making ground-based time-lapse imagery particularly valuable. Because earlier snowmelt is considered a primary driver of *Sasa* expansion (@Kudo2011EcoEvo), high-frequency and high-resolution data on snowmelt timing are essential for understanding and predicting its spread. Therefore, we also used imagery acquired from April to August between 2011 and 2021 to calculate the snowmelt day of year (DOY) for each pixel. Snowmelt detection followed a workflow based on Otsu’s binarization method (@otsu_binarization) as described in @IdeOguma2013EcolInfom. The extracted snowmelt DOYs were subsequently incorporated into the habitat suitability models (HSMs).

## Automated production of vegetation classification maps

Vegetation classification maps were produced using the method developed by @Okamoto2024RSEC, which consists of three main steps: image alignment, vegetation classification, and automated georectification.

- **Image alignment**: All images from 2012 and 2021 were aligned to enable precise temporal comparisons. Following @Okamoto2024RSEC, we applied a local-feature-based automated alignment approach.  
- **Vegetation classification**: Temporal changes in leaf color during autumn were analyzed using a recurrent neural network (RNN), which classified each pixel into seven categories: Dwarf Pine (*Pinus pumila*), Dwarf Bamboo (*Sasa* spp.), Rowans (*Sorbus sambucifolia*, *S. matsumurana*), Maple (*Acer tschonoskii*), Montane Alder (*Alnus viridis* subsp. *maximowiczii*), Other Vegetation (alpine shrubs and herbaceous plants), and No Vegetation.  
- **Automated georectification**: We automatically extracted ground control points (GCPs) from existing orthorectified aerial photographs and a digital elevation model (DEM), estimated camera parameters (orientation, focal length, and lens distortion), and transformed the images into georeferenced data at 1 m spatial resolution using the Python package `alproj` (https://github.com/0kam/alproj). The aerial photographs and DEM used for georectification were identical to those in @Okamoto2024RSEC.

## Quantification of *Sasa* expansion

To detect nine-year changes in *Sasa* distribution, we overlaid vegetation classification maps from 2012 and 2021 (@fig-vege12-21). We calculated the area occupied by *Sasa* in each year and quantified its expansion by comparing the two classification maps. Because *Sasa* can remain beneath shrub canopies, shrub encroachment and growth may cause *Sasa* to become undetectable in time-lapse imagery. Consequently, areas that appear to have decreased in *Sasa* cover may not represent true declines. To avoid underestimating expansion due to this limitation, we defined the primary expansion metric as the area of transitions from non-*Sasa* to *Sasa* (i.e., expansion area).


```{r}
#| label: fig-vege12-21
#| echo: false
#| message: false
#| fig-cap: |
#|   Vegetation classification results for 2012 and 2021.  
#|   Vegetation classification maps for 2012 (left) and 2021 (right). *Sasa* expansion was quantified by comparing the spatial extent of its distribution between the two maps.
#| out-width: 100%
#| fig-align: center
img <- c(image_read("files/2012_5x5_en.png"), image_read("files/2021_5x5_en.png"))
image_append(img)
```

## Habitat suitability modeling

To predict future *Sasa* expansion and understand its driver, we constructed habitat suitability models (HSMs). *Sasa* forms complex rhizome systems and extensive clonal networks (@Suyama2000MolEcol). While its expansion primarily occurs through rhizome elongation, seed dispersal can also take place after mass or partial flowering events (@Miyazaki2009JPlantRes; @Mizuki2014PLOS; @Kudo2011EcoEvo). As a result, *Sasa* can potentially expand both gradually through rhizome growth and over longer distances through seed dispersal.

To capture these contrasting dispersal processes, we developed two complementary models that predict the *Sasa* distribution observed in 2021 from environmental conditions and the baseline distribution in 2012. The **Topography-Based Model (TBM)** incorporates only topographic variables such as elevation, slope, and snowmelt DOY, representing potential expansion areas assuming that *Sasa* can disperse freely via seeds. In contrast, the **Topography–Distance Model (TDM)** additionally includes the distance from the 2012 *Sasa* distribution as a predictor, constraining the predicted 2021 distribution to areas near existing populations and thus reflecting the limited rhizome-based spread typical of *Sasa*. Comparing the two models allows us to distinguish between the broader potential niche under seed dispersal and the more localized realized expansion expected from clonal growth, providing a realistic range of possible future scenarios.


### Explanatory variables {#sec-explanatory}

Both models incorporated elevation, slope, aspect, roughness, the Terrain Ruggedness Index (TRI), the Topographic Position Index (TPI), and snowmelt day of year (DOY) as explanatory variables. These topographic features were derived from a 5 m digital elevation model (DEM) provided by the Geospatial Information Authority of Japan and resampled to 1 m resolution to match the vegetation maps.

Snowmelt DOYs were obtained from time-lapse imagery. Although interannual fluctuations were observed, snowmelt timing showed an advancing trend over the past decade. To represent this temporal trend, we fitted a linear regression to per-pixel snowmelt DOYs for each year from 2011 to 2021 and used the predicted 2021 values as explanatory variables in both models. The mean regression coefficient was −0.86, corresponding to an advance of 8.6 days per decade. For future projections, we extended the same regressions to estimate snowmelt DOYs for 2030 at each pixel. Although some areas obscured by foreground snow cover had uncertain snowmelt dates, these areas showed minimal overlap with the *Sasa* distribution and thus had little impact on our analysis. Additional details on snowmelt timing and its prediction are provided in the supplementary information. In the TDM, distance from the 2012 *Sasa* distribution was included as an additional explanatory variable to represent dispersal limitation.

### Target variable

The TBM was trained to predict the *Sasa* distribution in 2021. Because many *Sasa* patches present in 2012 persisted through 2021, pixels located directly within the 2012 distribution (i.e., at 0 m distance) were excluded from the TDM. Accordingly, the TDM was designed to predict newly colonized locations that appeared between 2012 and 2021.

### Data sampling and splitting

#### Data sampling

Because the *Sasa* distribution is relatively limited compared with other vegetation types (@fig-vege12-21), the dataset was imbalanced. To address this, presence data were retained at 1 m resolution, whereas absence data were downsampled to 5 m resolution to reduce dominance by non-*Sasa* pixels. Additionally, areas above 2,560 m—where *Sasa* does not occur—were excluded from the analysis.

#### Initial splitting

To evaluate model performance, we divided the dataset into 80% for training and 20% for testing. Given the strong spatial autocorrelation among explanatory variables, we applied spatial block splitting using the R packages `spatialsample` [@spatialsample] and `tidysdm` [@tidysdm] to mitigate overfitting effects (@fig-spatial-split, left).

```{r}
#| label: fig-spatial-split
#| echo: false
#| message: false
#| fig-cap: |
#|   Visualizations of spatial sampling.  
#|   The initial split is shown on the left, and the fourfold split used for cross-validation is shown on the right. Spatial sampling was implemented during data splitting to reduce the risk of model overfitting caused by spatial autocorrelation.
#| out-width: 100%
#| fig-align: center
img <- c(image_read("files/initial_split_dist.png"), image_read("files/cv_dist.png"))
image_append(img)
```

#### Cross-validation

For hyperparameter tuning and ensemble construction, we performed fourfold cross-validation using the same spatial block splitting approach (@fig-spatial-split, right) on the training dataset.

### Model preparation

#### Model training and evaluation

We applied four classification algorithms: gradient boosted trees (GBT; @Friedman2001GBM), maximum entropy (MaxEnt; @Philips2006MaxEnt), random forest (RF; @Breiman2001RandForest), and generalized additive models (GAM). For all models except GAM, hyperparameters were tuned via grid search with up to 18 trials. Model performance was evaluated using the True Skill Statistic (TSS; @Allouche2006TSS; see @eq-tss-formula), which ranges from 0 to 1, with higher values indicating greater predictive accuracy. \(TP\), \(FP\), and \(FN\) denote the numbers of true positives, false positives, and false negatives, respectively.

$$
\begin{gathered}
recall = \frac{TP}{TP + FN} \\
specificity = \frac{TN}{TN + FP} \\
TSS = recall + specificity - 1 \\
\end{gathered}
$$ {#eq-tss-formula}

#### Model ensembling

We constructed ensemble models using the `blend_predictions` function in the R package `stacks` (@RCranStack), which estimates blending coefficients via LASSO regularization to maximize cross-validated performance. The ensemble TSS was subsequently evaluated on the independent test dataset.

#### Variable importance computation

For both the TBM and TDM, variable importance was assessed using permutation loss, defined as the reduction in TSS observed when each explanatory variable was randomly permuted. This measure quantifies the relative contribution of each variable to the overall predictive performance of the model.

### Future prediction and definition of risky areas

Using ensemble models built for each of the TBM and TDM, we predicted *Sasa* distribution for 2030 based on the estimated snowmelt DOYs (see @sec-explanatory). In this framework, predictions from the TBM represent areas that could become suitable if *Sasa* disperses via seeds. Under such conditions, *Sasa* is particularly likely to invade low-height alpine grasslands, which correspond to the “Other Vegetation” category in our classification. For conservation purposes, we therefore defined “risky areas” as cells classified as “Other Vegetation” in 2021 whose TBM-predicted habitat suitability (HS) for 2030 exceeded 0.5, and we extracted their spatial distribution accordingly.
