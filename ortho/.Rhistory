setwd("/media/okamoto/HDD3TB/tateyama/mrd_snowmelt/step2_ortho/")
library(sf)
library(stars)
library(tidyverse)
library(stringr)
# Read result csv file
ortho <- function(in_path, out_path) {
points <- read_csv(
in_path,
col_types = cols_only(x = "d", y = "d", snow_melt = "d")
) %>%
mutate(snow_melt = as.integer(snow_melt))
# Converting the dataframe to points.
points <- points %>%
st_as_sf(coords = c("x", "y"))
res <- 1
# Rsaterize
snow <- points %>%
select(snow_melt) %>%
st_rasterize(dx = res, dy = res)
rm(points)
gc()
snow <- snow %>%
`st_crs<-`(6690)
# Plotting
p <- ggplot() +
geom_stars(data = snow)
ggsave(file = str_replace(out_path, "tiff", "png"), plot = p)
# Saving raster data as a GeoTiff file.
write_stars(snow, out_path)
rm(snow)
gc()
}
files <- list.files("snowmelt_ortho/", full.names = T) %>%
str_subset("csv")
files
files <- list.files("snowmelt_aligned/", full.names = T) %>%
str_subset("csv")
files
list.files("snowmelt_aligned/", full.names = T)
setwd("/media/okamoto/HDD3TB/tateyama/mrd_snowmelt/step2_ortho/")
library(sf)
library(stars)
library(tidyverse)
library(stringr)
# Read result csv file
ortho <- function(in_path, out_path) {
points <- read_csv(
in_path,
col_types = cols_only(x = "d", y = "d", snow_melt = "d")
) %>%
mutate(snow_melt = as.integer(snow_melt))
# Converting the dataframe to points.
points <- points %>%
st_as_sf(coords = c("x", "y"))
res <- 1
# Rsaterize
snow <- points %>%
select(snow_melt) %>%
st_rasterize(dx = res, dy = res)
rm(points)
gc()
snow <- snow %>%
`st_crs<-`(6690)
# Plotting
p <- ggplot() +
geom_stars(data = snow)
ggsave(file = str_replace(out_path, "tiff", "png"), plot = p)
# Saving raster data as a GeoTiff file.
write_stars(snow, out_path)
rm(snow)
gc()
}
files <- list.files("snowmelt_aligned/", full.names = T) %>%
str_subset("csv")
files
setwd("/media/okamoto/HDD3TB/tateyama/mrd_snowmelt/step2_ortho/")
files <- list.files("snowmelt_aligned/", full.names = T) %>%
str_subset("csv")
files
library(magick)
library(imager)
library(tidyverse)
library(shapes)
library(spatstat)
library(fields)
setwd("~/HDD3TB/mrd_snowmelt/step2_ortho/")
setwd("~/HDD3TB/mrd_snowmelt/step2_ortho/")
setwd("~/HDD3TB/tateyama/mrd_snowmelt/step2_ortho/")
control_points <- read_csv("gcp.csv")
control_points <- read_csv("gcp.csv")
points_sim <- read_csv("georectificated.csv",
col_types = cols(
x = col_double(),
y = col_double()
)
) %>% rename(pix_num = X1)
read_csv("georectificated.csv",
col_types = cols(
x = col_double(),
y = col_double()
)
)
points_sim <- read_csv("georectificated.csv",
col_types = cols(
x = col_double(),
y = col_double()
)
) %>% rename(pix_num = ...1)
org_m <- matrix(c(control_points$org_x, control_points$org_y), ncol = 2)
org_m <- cbind(org_m, rep(1,nrow(org_m))) # for affine translation
sim_m <- matrix(c(control_points$sim_x, control_points$sim_y), ncol = 2)
sim_m <- cbind(sim_m, rep(1,nrow(sim_m))) # for affine translation
xdiff <- mean(sim_m[,1] - org_m[,1])
ydiff <- mean(sim_m[,2] - org_m[,2])
p <- matrix(c(1,0,xdiff, 0,1,ydiff, 0,0,1), 3,3) # for parallel translation
org_p <- org_m %*% p # parallel translated
proc <- procOPA(sim_m, org_p)
rotation <- proc$R # for rotation
scale <- rbind(diag(c(proc$s,proc$s)), c(0,0)) %>% cbind(c(0,0,1)) # for scaling
org_aff <- org_p %*% rotation %*% scale
xdiff
proc <- procOPA(sim_m, org_p)
rotation <- proc$R # for rotation
scale <- rbind(diag(c(proc$s,proc$s)), c(0,0)) %>% cbind(c(0,0,1)) # for scaling
org_aff <- org_p %*% rotation %*% scale
par(mfcol = c(1,2))
plot(sim_m, xlim = c(0,6000), ylim = c(0,5000))
plot(org_aff, xlim = c(0,6000), ylim = c(0,5000))
fit_x <- Tps(org_aff[,c(1,2)], sim_m[,1]) # delete org_aff[,3]
fit_y <- Tps(org_aff[,c(1,2)], sim_m[,2])
corr_x <- predict(fit_x, expand.grid(170*1:30,170*1:40))
corr_y <- predict(fit_y, expand.grid(170*1:30,170*1:40))
plot(corr_x, corr_y)
org_tps <- matrix(c(predict(fit_x, org_aff[,c(1,2)]), predict(fit_y, org_aff[,c(1,2)])), ncol = 2)
plot(sim_m, xlim = c(0,6000), ylim = c(0,5000))
par(new = T)
plot(org_tps, xlim = c(0,6000), ylim = c(0,5000), col = "red")
arrows(sim_m[,1], sim_m[,2], org_aff[,1], org_aff[,2])
rmse <- tibble(
tps_x = org_tps[,1],
tps_y = org_tps[,2],
sim_x = sim_m[,1],
sim_y = sim_m[,2]
) %>%
mutate(se = (tps_x - sim_x)^2 + (tps_y - sim_y)^2) %>%
summarise(rmse = mean(sqrt(se)))
rmse %>%
write_csv("TPS_rmse.csv")
org_width <- 5616
org_height <- 3744
sim_width <- 5616
sim_height <- 3744
org_cells <- expand.grid(1:org_width,1:org_height)
org_cells <- cbind(org_cells, rep(1,nrow(org_cells))) %>% as.matrix()
org_cells_affine <- org_cells %*% p %*% rotation %*% scale
corrected <- tibble(
corr_x = round(as.vector(predict(fit_x, org_cells_affine[,c(1,2)])),digits = 0),
corr_y = round(as.vector(predict(fit_y, org_cells_affine[,c(1,2)])),digits = 0)
) %>% mutate(pix_num = (corr_y - 1) * sim_width + corr_x) %>%
left_join(points_sim, by = "pix_num") %>% dplyr::select(x,y)
gc()
files <- list.files("snowmelt_aligned/", full.names = T)
files
f <- files[11]
f
snow <- load.image(f)
melt <- snow[,,1,1] %>% as.vector()
melt2 <- melt *255 %>% round(digits = 0)
result <- mutate(corrected, snow_melt = as.integer(melt2)) %>%
filter(x != 0,
snow_melt != 0
)
out <- str_replace(f, "snowmelt_aligned/", "snowmelt_ortho/") %>%
str_replace("png", "csv")
write_csv(result, out)
for (f in files) {
snow <- load.image(f)
melt <- snow[,,1,1] %>% as.vector()
melt2 <- melt *255 %>% round(digits = 0)
#change imager color(0 to 1) to DOY(1 to 255)
result <- mutate(corrected, snow_melt = as.integer(melt2)) %>%
filter(x != 0,
snow_melt != 0
)
out <- str_replace(f, "snowmelt_aligned/", "snowmelt_ortho/") %>%
str_replace("png", "csv")
write_csv(result, out)
gc()
}
setwd("/media/okamoto/HDD3TB/tateyama/mrd_snowmelt/step2_ortho/")
library(sf)
library(stars)
library(tidyverse)
library(stringr)
# Read result csv file
ortho <- function(in_path, out_path) {
points <- read_csv(
in_path,
col_types = cols_only(x = "d", y = "d", snow_melt = "d")
) %>%
mutate(snow_melt = as.integer(snow_melt))
# Converting the dataframe to points.
points <- points %>%
st_as_sf(coords = c("x", "y"))
res <- 1
# Rsaterize
snow <- points %>%
select(snow_melt) %>%
st_rasterize(dx = res, dy = res)
rm(points)
gc()
snow <- snow %>%
`st_crs<-`(6690)
# Plotting
p <- ggplot() +
geom_stars(data = snow)
ggsave(file = str_replace(out_path, "tiff", "png"), plot = p)
# Saving raster data as a GeoTiff file.
write_stars(snow, out_path)
rm(snow)
gc()
}
files <- list.files("snowmelt_aligned/", full.names = T) %>%
str_subset("csv")
for (f in files) {
out <- str_replace(f, "csv", "tiff")
ortho(f, out)
}
files
files <- list.files("snowmelt_ortho//", full.names = T) %>%
str_subset("csv")
for (f in files) {
out <- str_replace(f, "csv", "tiff")
ortho(f, out)
}
setwd("~/Projects/jasms2023f/ortho/")
library(sf)
library(tidyverse)
library(stars)
library(terra)
concat_df <- function(in_path, target = "data/georectified.csv") {
print(target)
georec_df <- target %>%
read_csv() %>%
select(u, v, x, y, z)
df <- read_csv(in_path)
georec_df %>%
left_join(df, by = c("u", "v"))
}
interpolate <- function(in_path, out_path, res, max_dist, fun=terra::modal, target = "data/georectified.csv") {
print(str_c("Reading ", in_path, " ......"))
points <- in_path %>%
concat_df(target = target) %>%
st_as_sf(coords = c("x", "y")) %>%
st_set_crs(6690) %>%
mutate(z = as.integer(z)) %>%
select(-c(u, v, z))
print("Rasterizing point data ......")
ras <- st_rasterize(points, dx = res, dy = res)
rm(points)
gc()
ras <- ras %>%
as("Raster") %>%
terra::rast()
times <- ceiling(max_dist / res)
for (i in 1:times) {
print(str_c("Interpolating ......", i, " of ", times, " iterations"))
ras <- ras %>%
terra::focal(3, fun, na.policy="only", na.rm=TRUE)
}
print(str_c("Saving file to ", out_path, " ......"))
terra::writeRaster(ras, out_path, overwrite=TRUE)
rm(ras)
gc()
print("Finished !")
}
files <- list.files("data/snow/aligned/*.csv", full.names = T)
out_paths <- stringr::str_replace(files, "csv", "tiff") %>% str_replace("data/", "data/vege_")
files <- list.files("data/snow/aligned/*.csv", full.names = T)
out_paths <- stringr::str_replace(files, "csv", "tiff") %>% str_replace("data/", "data/vege_")
for (i in 1:length(files)) {
interpolate(
files[i],
out_paths[i],
1.0,
1.0
)
}
files
files <- list.files("data/snow/aligned/*.csv", full.names = T)
files
files <- list.files("data/snow/aligned/", "*.csv", full.names = T)
files
out_paths <- stringr::str_replace(files, "csv", "tiff") %>% str_replace("data/", "data/vege_")
for (i in 1:length(files)) {
interpolate(
files[i],
out_paths[i],
1.0,
1.0
)
}
files <- list.files("data/snow/aligned/", "*.csv", full.names = T)
out_paths <- stringr::str_replace(files, "csv", "tiff") %>% str_replace("aligned/", "raw/")
out_paths
for (i in 1:length(files)) {
interpolate(
files[i],
out_paths[i],
1.0,
1.0
)
}
